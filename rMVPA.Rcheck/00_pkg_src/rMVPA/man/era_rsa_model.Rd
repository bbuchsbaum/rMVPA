% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/era_rsa_model.R
\name{era_rsa_model}
\alias{era_rsa_model}
\title{ERA-RSA: Encoding–Retrieval Similarity and ER Geometry}
\usage{
era_rsa_model(
  dataset,
  design,
  key_var,
  phase_var,
  encoding_level = NULL,
  retrieval_level = NULL,
  distfun = cordist(method = "pearson"),
  rsa_simfun = c("pearson", "spearman"),
  confound_rdms = NULL,
  include_diag = TRUE,
  item_block = NULL,
  item_lag = NULL,
  item_run_enc = NULL,
  item_run_ret = NULL,
  ...
)
}
\arguments{
\item{dataset}{An mvpa_dataset with train_data (encoding) and test_data (retrieval).}

\item{design}{An mvpa_design describing trial structure with train/test designs.}

\item{key_var}{Column name or formula giving the item key that links encoding
and retrieval trials (e.g., ~ ImageID).}

\item{phase_var}{Column name or formula giving phase labels (must include
encoding and retrieval levels if using a single-phase dataset; for the
default two-dataset usage, this is still parsed for consistency but not
required for operations).}

\item{encoding_level}{Level of phase_var to treat as encoding (default: first level).}

\item{retrieval_level}{Level of phase_var to treat as retrieval (default: second level).}

\item{distfun}{A distfun used to compute within-phase RDMs (e.g., cordist("pearson")).}

\item{rsa_simfun}{Character: similarity for comparing RDMs, one of "pearson" or "spearman".}

\item{confound_rdms}{Optional named list of KxK matrices or "dist" objects
encoding item-level nuisance/model RDMs (e.g., block, run, time). Rows
and columns should correspond to item keys (levels of \code{key_var}).
When \code{run_enc} and \code{run_ret} entries are present they are used
to compute \code{geom_cor_run_partial}, the ER geometry correlation after
regressing out these run confounds.}

\item{include_diag}{Logical; if TRUE (default) ERA off-diagonal mean excludes diagonal
by setting it to NA first; diagonal metrics are always retained.}

\item{item_block}{Optional factor of per-item blocks, aligned to item keys.
Typically derived by aggregating a trial-level block/run variable in
\code{design$train_design} to the item level (e.g., modal block per item).
Used to compute block-limited ERA contrasts
(\code{era_diag_minus_off_same_block} / \code{era_diag_minus_off_diff_block}).}

\item{item_lag}{Optional numeric per-item retrieval-minus-encoding lag,
aligned to item keys. Often derived from trial onsets (e.g., mean
retrieval onset minus mean encoding onset per item). Used to compute
\code{era_lag_cor}, the correlation between ERA diagonal and lag.}

\item{item_run_enc}{Optional factor of per-item encoding runs, aligned to
item keys (e.g., modal run for encoding trials of each item). Combined
with \code{item_run_ret} to compute \code{geom_cor_xrun}, ER geometry
restricted to item pairs differing in both encoding and retrieval run.}

\item{item_run_ret}{Optional factor of per-item retrieval runs, aligned to
item keys. See \code{item_run_enc} for how it is used.}

\item{...}{Additional fields stored on the model spec.}
}
\value{
A model spec of class "era_rsa_model" compatible with run_regional()/run_searchlight().
}
\description{
Combines first-order encoding–retrieval similarity (ERA) with second-order
RSA between encoding and retrieval representational geometries. Works with
\code{run_regional()} and \code{run_searchlight()} using the standard rMVPA
iterators.
}
\details{
Key outputs per ROI/searchlight sphere include:
- First-order ERA: top-1 accuracy, diagonal mean, diagonal-minus-off.
- Second-order geometry: correlation between encoding and retrieval RDMs.
- Optional confound-aware metrics and diagnostics (block/lag/run).
}
\section{Metrics}{

For each ROI / searchlight center, \code{era_rsa_model} emits a set of
scalar metrics that are turned into spatial maps by \code{run_regional()}
and \code{run_searchlight()}:
\describe{
  \item{n_items}{
    Number of unique item keys contributing to this ROI/sphere
    (i.e., length of the common encoding–retrieval item set).
  }
  \item{era_top1_acc}{
    Top-1 encoding\eqn{\rightarrow}retrieval accuracy at the item level:
    fraction of retrieval trials whose most similar encoding pattern
    (over items) has the same \code{key_var}.
  }
  \item{era_diag_mean}{
    Mean encoding–retrieval similarity for matching items
    (mean of the diagonal of the encoding\eqn{\times}retrieval similarity
    matrix).
  }
  \item{era_diag_minus_off}{
    Diagonal-minus-off-diagonal ERA contrast: \code{era_diag_mean} minus
    the mean similarity to all non-matching items, capturing how much
    same-item pairs stand out from other pairs.
  }
  \item{geom_cor}{
    Correlation between encoding and retrieval representational geometries:
    correlation (Pearson or Spearman, per \code{rsa_simfun}) between the
    vectorised lower triangles of the encoding and retrieval RDMs.
  }
  \item{era_diag_minus_off_same_block}{
    Block-limited ERA contrast when \code{item_block} is supplied:
    diagonal ERA minus the mean similarity to other items in the same
    block (e.g., run/condition), averaged over items.
  }
  \item{era_diag_minus_off_diff_block}{
    Cross-block ERA contrast when \code{item_block} is supplied:
    diagonal ERA minus the mean similarity to items in different blocks.
  }
  \item{era_lag_cor}{
    Lag–ERA correlation when \code{item_lag} is supplied: Spearman
    correlation between diagonal ERA values and the per-item lag
    (e.g., retrieval minus encoding onset), using complete cases only.
  }
  \item{geom_cor_run_partial}{
    Run-partial ER geometry correlation, when run-level confounds are
    supplied via \code{confound_rdms$run_enc} and \code{confound_rdms$run_ret}.
    Computed as the correlation between encoding and retrieval RDMs
    after regressing out those run RDMs.
  }
  \item{geom_cor_xrun}{
    Cross-run-only ER geometry correlation, when \code{item_run_enc} and
    \code{item_run_ret} are supplied: correlation between encoding and
    retrieval RDMs restricted to item pairs that differ in both encoding
    and retrieval run.
  }
  \item{beta_*}{
    When \code{confound_rdms} are provided, additional \code{beta_<name>}
    terms give the regression coefficients from a linear model predicting
    retrieval geometry from encoding geometry and the confound RDMs
    (one coefficient per nuisance/model RDM).
  }
  \item{sp_*}{
    If \code{run_lm_semipartial()} is available, \code{sp_<name>} terms
    provide semi-partial R\eqn{^2}-like diagnostics for each confound RDM,
    quantifying unique variance explained in retrieval geometry.
  }
}
}

